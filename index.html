<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LDSS v5 - Autonomous Worker</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:system-ui;background:#0a0a12;color:#e0e0e0;padding:1rem;min-height:100vh}
    h1{font-size:1.3rem;background:linear-gradient(90deg,#00d4ff,#7b2cbf);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;flex-wrap:wrap;gap:1rem}
    .status{display:flex;align-items:center;gap:.5rem}
    .dot{width:10px;height:10px;border-radius:50%;background:#22c55e;box-shadow:0 0 8px #22c55e;animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
    .badge{background:#7b2cbf;color:#fff;padding:.3rem .7rem;border-radius:6px;font-size:.75rem;font-weight:bold}
    .worker-status{background:rgba(34,197,94,.1);border:2px solid #22c55e;border-radius:8px;padding:1rem;margin-bottom:1rem}
    .worker-status h3{margin-bottom:.5rem;display:flex;align-items:center;gap:.5rem;color:#22c55e}
    .stat-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:.5rem;margin:1rem 0}
    .stat{background:rgba(0,212,255,.05);border:1px solid rgba(0,212,255,.2);border-radius:6px;padding:.5rem;text-align:center}
    .stat-val{font-size:1.5rem;font-weight:bold;color:#00d4ff}
    .stat-label{font-size:.65rem;color:#888;margin-top:.3rem}
    .log-box{background:#000;border:2px solid #7b2cbf;border-radius:8px;padding:.75rem;font-family:monospace;font-size:.75rem;max-height:300px;overflow-y:auto}
    .log-entry{padding:.3rem 0;border-bottom:1px solid #1a1a2e}
    .log-entry:last-child{border:none}
    .log-success{color:#22c55e}
    .log-error{color:#ef4444}
    .log-info{color:#00d4ff}
    .log-time{color:#666;margin-right:.5rem}
    .config-box{background:rgba(234,179,8,.1);border:1px solid #eab308;border-radius:8px;padding:1rem;margin-bottom:1rem}
    .config-box input{background:#1a1a2e;border:1px solid #3a3a4e;color:#e0e0e0;padding:.5rem;border-radius:4px;width:100%;margin-top:.5rem}
    .btn{background:linear-gradient(90deg,#7b2cbf,#00d4ff);border:none;padding:.5rem 1rem;border-radius:6px;color:#fff;font-weight:600;cursor:pointer;margin-top:.5rem}
  </style>
</head>
<body>
  <div class="header">
    <div>
      <h1>ü§ñ LDSS v5 - Autonomous Worker</h1>
      <span class="badge">AUTO-POLLING</span>
    </div>
    <div class="status">
      <div class="dot" id="dot"></div>
      <span id="status">Starting...</span>
    </div>
  </div>

  <div class="config-box">
    <label style="color:#eab308;font-weight:600">üîß Configuration Serveur</label>
    <input type="text" id="serverUrl" placeholder="https://ton-serveur.onrender.com" value="">
    <button class="btn" onclick="updateServerUrl()">üíæ Mettre √† jour</button>
    <div style="font-size:.8rem;color:#888;margin-top:.5rem">
      Le worker poll automatiquement ce serveur toutes les 5 secondes
    </div>
  </div>

  <div class="worker-status">
    <h3>üîÑ √âtat du Worker</h3>
    <div class="stat-grid">
      <div class="stat">
        <div class="stat-val" id="pollCount">0</div>
        <div class="stat-label">Polls effectu√©s</div>
      </div>
      <div class="stat">
        <div class="stat-val" id="downloadCount">0</div>
        <div class="stat-label">T√©l√©chargements</div>
      </div>
      <div class="stat">
        <div class="stat-val" id="storedCount">0</div>
        <div class="stat-label">Stock√©s</div>
      </div>
      <div class="stat">
        <div class="stat-val" id="errorCount">0</div>
        <div class="stat-label">Erreurs</div>
      </div>
    </div>
    <div style="text-align:center;color:#888;font-size:.8rem">
      Prochain poll dans <span id="nextPoll">5</span>s
    </div>
  </div>

  <div style="margin-bottom:.5rem">
    <strong style="color:#00d4ff">üìã Logs en temps r√©el</strong>
  </div>
  <div class="log-box" id="logs"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LDSS v5 - AUTONOMOUS WORKER
// Poll automatiquement un serveur et stocke les donn√©es
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const WORKER = {
  db: null,
  serverUrl: localStorage.getItem('ldss_server_url') || '',
  pollInterval: 5000, // 5 secondes
  pollCount: 0,
  downloadCount: 0,
  storedCount: 0,
  errorCount: 0,
  isPolling: false,
  
  async init() {
    // Ouvrir IndexedDB
    return new Promise((res, rej) => {
      const req = indexedDB.open('LDSS_v5', 1);
      req.onerror = () => rej(req.error);
      req.onsuccess = () => { 
        this.db = req.result; 
        res(); 
      };
      req.onupgradeneeded = e => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains('storage')) {
          const store = db.createObjectStore('storage', { keyPath: 'id' });
          store.createIndex('timestamp', 'timestamp', { unique: false });
          store.createIndex('dataId', 'dataId', { unique: false });
        }
      };
    });
  },
  
  log(type, message) {
    const time = new Date().toLocaleTimeString();
    const logEl = document.getElementById('logs');
    const entry = document.createElement('div');
    entry.className = `log-entry log-${type}`;
    entry.innerHTML = `<span class="log-time">${time}</span>${message}`;
    logEl.insertBefore(entry, logEl.firstChild);
    
    // Garder seulement les 50 derniers logs
    while (logEl.children.length > 50) {
      logEl.removeChild(logEl.lastChild);
    }
    
    console.log(`[${type.toUpperCase()}] ${message}`);
  },
  
  async poll() {
    if (!this.serverUrl) {
      this.log('info', '‚è∏Ô∏è  Pas de serveur configur√©, en attente...');
      return;
    }
    
    this.pollCount++;
    document.getElementById('pollCount').textContent = this.pollCount;
    
    try {
      this.log('info', `üîç Poll ${this.pollCount}: ${this.serverUrl}/api/pending`);
      
      const response = await fetch(`${this.serverUrl}/api/pending`, {
        method: 'GET',
        headers: { 'Content-Type': 'application/json' }
      });
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }
      
      const pending = await response.json();
      
      if (pending.ids && pending.ids.length > 0) {
        this.log('success', `üì¶ ${pending.ids.length} donn√©es en attente`);
        
        for (const id of pending.ids) {
          await this.downloadAndStore(id);
        }
      } else {
        this.log('info', '‚úì Aucune donn√©e en attente');
      }
      
    } catch(e) {
      this.errorCount++;
      document.getElementById('errorCount').textContent = this.errorCount;
      this.log('error', `‚ùå Erreur poll: ${e.message}`);
    }
  },
  
  async downloadAndStore(id) {
    try {
      this.log('info', `üì• T√©l√©chargement: ${id}`);
      
      const response = await fetch(`${this.serverUrl}/api/queue/${id}`, {
        method: 'GET',
        headers: { 'Content-Type': 'application/json' }
      });
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }
      
      const payload = await response.json();
      
      this.downloadCount++;
      document.getElementById('downloadCount').textContent = this.downloadCount;
      
      // Stocker dans IndexedDB
      await this.store(id, payload);
      
      // Confirmer au serveur
      await fetch(`${this.serverUrl}/api/confirm/${id}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      
      this.log('success', `‚úÖ Stock√©: ${id} (${JSON.stringify(payload).length} bytes)`);
      
    } catch(e) {
      this.errorCount++;
      document.getElementById('errorCount').textContent = this.errorCount;
      this.log('error', `‚ùå Erreur download ${id}: ${e.message}`);
    }
  },
  
  async store(dataId, data) {
    return new Promise((res, rej) => {
      const tx = this.db.transaction(['storage'], 'readwrite');
      const store = tx.objectStore('storage');
      
      // ‚úÖ Utiliser dataId comme ID principal pour faciliter la r√©cup√©ration
      const record = {
        id: dataId, // ‚úÖ UTILISER LE M√äME ID
        dataId: dataId,
        data: data,
        timestamp: Date.now(),
        size: JSON.stringify(data).length
      };
      
      // Supprimer l'ancien si existe
      const deleteReq = store.delete(dataId);
      deleteReq.onsuccess = () => {
        const req = store.add(record);
        req.onsuccess = () => {
          this.storedCount++;
          document.getElementById('storedCount').textContent = this.storedCount;
          res(req.result);
        };
        req.onerror = () => rej(req.error);
      };
      deleteReq.onerror = () => {
        // Pas grave si n'existe pas, on ajoute quand m√™me
        const req = store.add(record);
        req.onsuccess = () => {
          this.storedCount++;
          document.getElementById('storedCount').textContent = this.storedCount;
          res(req.result);
        };
        req.onerror = () => rej(req.error);
      };
    });
  },
  
  async read(dataId) {
    return new Promise((res, rej) => {
      const tx = this.db.transaction(['storage'], 'readonly');
      const store = tx.objectStore('storage');
      
      // ‚úÖ Lire directement par ID
      const req = store.get(dataId);
      
      req.onsuccess = () => {
        if (req.result) {
          res({
            ok: true,
            dataId: dataId,
            count: 1,
            data: [req.result]
          });
        } else {
          // Fallback: chercher par index
          const idx = store.index('dataId');
          const idxReq = idx.getAll(dataId);
          
          idxReq.onsuccess = () => {
            res({
              ok: true,
              dataId: dataId,
              count: idxReq.result.length,
              data: idxReq.result
            });
          };
          idxReq.onerror = () => rej(idxReq.error);
        }
      };
      req.onerror = () => rej(req.error);
    });
  },
  
  async readAll() {
    return new Promise((res, rej) => {
      const tx = this.db.transaction(['storage'], 'readonly');
      const req = tx.objectStore('storage').getAll();
      
      req.onsuccess = () => {
        res({
          ok: true,
          count: req.result.length,
          data: req.result
        });
      };
      req.onerror = () => rej(req.error);
    });
  },
  
  startPolling() {
    if (this.isPolling) return;
    this.isPolling = true;
    
    const pollLoop = async () => {
      await this.poll();
      
      // Countdown
      let remaining = this.pollInterval / 1000;
      const countdown = setInterval(() => {
        remaining--;
        document.getElementById('nextPoll').textContent = remaining;
        if (remaining <= 0) clearInterval(countdown);
      }, 1000);
      
      setTimeout(pollLoop, this.pollInterval);
    };
    
    pollLoop();
    this.log('success', 'üöÄ Worker d√©marr√©, polling toutes les 5s');
  }
};

// Exposer globalement pour Puppeteer
window.LDSS_WORKER = WORKER;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UI FUNCTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function updateServerUrl() {
  const url = document.getElementById('serverUrl').value.trim();
  if (!url) {
    alert('‚ùå URL vide');
    return;
  }
  
  WORKER.serverUrl = url;
  localStorage.setItem('ldss_server_url', url);
  WORKER.log('success', `‚úÖ Serveur configur√©: ${url}`);
  
  if (!WORKER.isPolling) {
    WORKER.startPolling();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

(async () => {
  try {
    await WORKER.init();
    document.getElementById('status').textContent = 'Online';
    document.getElementById('dot').style.background = '#22c55e';
    
    // Charger l'URL sauvegard√©e
    if (WORKER.serverUrl) {
      document.getElementById('serverUrl').value = WORKER.serverUrl;
      WORKER.startPolling();
    } else {
      WORKER.log('info', '‚ÑπÔ∏è  Configurez l\'URL du serveur pour d√©marrer');
    }
    
    WORKER.log('success', '‚úÖ LDSS Worker v5 initialis√©');
    
  } catch(e) {
    document.getElementById('status').textContent = 'Error';
    document.getElementById('dot').style.background = '#ef4444';
    WORKER.log('error', `‚ùå Erreur init: ${e.message}`);
  }
})();
</script>
</body>
</html>